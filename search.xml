<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ansible 服务器 exporter playbook</title>
    <url>/2023/05/19/ansible-%E6%9C%8D%E5%8A%A1%E5%99%A8-exporter-playbook/</url>
    <content><![CDATA[<p>just playbook yaml, no more</p>
<span id="more"></span>
<p>Node exporter<br>playbooks</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">configure</span> <span class="string">Node</span> <span class="string">Exporter</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">node_exporter_version:</span> <span class="string">&quot;1.5.0&quot;</span></span><br><span class="line">    <span class="attr">node_exporter_download_url:</span> <span class="string">&quot;https://github.com/prometheus/node_exporter/releases/download/v<span class="template-variable">&#123;&#123; node_exporter_version &#125;&#125;</span>/node_exporter-<span class="template-variable">&#123;&#123; node_exporter_version &#125;&#125;</span>.<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-amd64.tar.gz&quot;</span></span><br><span class="line">    <span class="attr">node_exporter_install_dir:</span> <span class="string">&quot;/opt/node_exporter&quot;</span></span><br><span class="line">    <span class="attr">node_exporter_config_file:</span> <span class="string">&quot;/etc/node_exporter/node_exporter.yml&quot;</span></span><br><span class="line">    <span class="attr">node_exporter_scrape_interval:</span> <span class="string">&quot;30s&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">exporter</span> <span class="string">group</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">name=exporter</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">node_exporter</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">          <span class="string">name=node_exporter</span></span><br><span class="line">          <span class="string">comment=&quot;prometheus</span> <span class="string">node_exporter</span> <span class="string">user&quot;</span></span><br><span class="line">          <span class="string">group=exporter</span></span><br><span class="line">          <span class="string">shell=/sbin/nologin</span></span><br><span class="line">          <span class="string">createhome=no</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">and</span> <span class="string">extract</span> <span class="string">Node</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">get_url:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; node_exporter_download_url &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">&quot;/tmp/node_exporter.tar.gz&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">node_exporter_download</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">Node</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">unarchive:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">&quot;/tmp/node_exporter.tar.gz&quot;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; node_exporter_install_dir &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">remote_src:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">node_exporter_download.changed</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Node</span> <span class="string">Exporter</span> <span class="string">config</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; node_exporter_config_file | dirname &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Node</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">&quot;templates/node_exporter.yml.j2&quot;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; node_exporter_config_file &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">node_exporter_download.changed</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Node</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node_exporter</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">node_exporter_download.changed</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Reload</span> <span class="string">systemd</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">daemon_reload:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">Node</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node_exporter</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br></pre></td></tr></table></figure>

<p>node_exporter.yml.j2</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> &#123;&#123; <span class="string">node_exporter_scrape_interval</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">collectors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cpu</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">diskstats</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">filesystem</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">filefd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">loadavg</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">stat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">time</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vmstat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tcpstat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">meminfo</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">netstat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">uname</span></span><br></pre></td></tr></table></figure>
<p>wmi exporter</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">and</span> <span class="string">configure</span> <span class="string">WMI</span> <span class="string">Exporter</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">windows_servers</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">wmi_exporter_version:</span> <span class="string">&quot;0.22.0&quot;</span></span><br><span class="line">    <span class="attr">wmi_exporter_download_url:</span> <span class="string">&quot;https://github.com/martinlindhe/wmi_exporter/releases/download/v<span class="template-variable">&#123;&#123; wmi_exporter_version &#125;&#125;</span>/wmi_exporter-<span class="template-variable">&#123;&#123; wmi_exporter_version &#125;&#125;</span>.windows-amd64.zip&quot;</span></span><br><span class="line">    <span class="attr">wmi_exporter_install_dir:</span> <span class="string">&quot;C:\\Program Files\\wmi_exporter&quot;</span></span><br><span class="line">    <span class="attr">wmi_exporter_config_file:</span> <span class="string">&quot;C:\\Program Files\\wmi_exporter\\wmi_exporter.yml&quot;</span></span><br><span class="line">    <span class="attr">wmi_exporter_scrape_interval:</span> <span class="string">&quot;30s&quot;</span></span><br><span class="line">    <span class="attr">wmi_exporter_collectors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cpu</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cpu_info</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">memory</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">logical_disk</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">os</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">system</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">process</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">net</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tcp</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="comment"># Download and extract WMI Exporter</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">WMI</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">win_get_url:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; wmi_exporter_download_url &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; playbook_dir &#125;&#125;</span>/wmi_exporter.zip&quot;</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">wmi_exporter_download</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Extract</span> <span class="string">WMI</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">win_unzip:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; playbook_dir &#125;&#125;</span>/wmi_exporter.zip&quot;</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; wmi_exporter_install_dir &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">wmi_exporter_download.changed</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Configure WMI Exporter</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">WMI</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">win_template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">templates/wmi_exporter.yml.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; wmi_exporter_config_file &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">wmi_exporter_scrape_interval:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; wmi_exporter_scrape_interval &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">wmi_exporter_collectors:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; wmi_exporter_collectors &#125;&#125;</span>&quot;</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">wmi_exporter_download.changed</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Start WMI Exporter service</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">WMI</span> <span class="string">Exporter</span></span><br><span class="line">      <span class="attr">win_service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">wmi_exporter</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">wmi_exporter_download.changed</span></span><br><span class="line"><span class="string">```</span>      </span><br><span class="line"><span class="string">wmi_exporter.yml.j2</span></span><br><span class="line"><span class="string">```yaml</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> &#123;&#123; <span class="string">wmi_exporter_scrape_interval</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">collectors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cpu</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">logical_disk</span></span><br><span class="line">  &#123;<span class="string">%</span> <span class="string">if</span> <span class="string">&#x27;memory&#x27;</span> <span class="string">in</span> <span class="string">wmi_exporter_collectors</span> <span class="string">%</span>&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="string">memory</span></span><br><span class="line">  &#123;<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>&#125;</span><br><span class="line">  &#123;<span class="string">%</span> <span class="string">if</span> <span class="string">&#x27;net&#x27;</span> <span class="string">in</span> <span class="string">wmi_exporter_collectors</span> <span class="string">%</span>&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="string">net</span></span><br><span class="line">  &#123;<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>&#125;</span><br><span class="line">  &#123;<span class="string">%</span> <span class="string">if</span> <span class="string">&#x27;os&#x27;</span> <span class="string">in</span> <span class="string">wmi_exporter_collectors</span> <span class="string">%</span>&#125;</span><br><span class="line">  <span class="bullet">-</span> <span class="string">os</span></span><br><span class="line">  &#123;<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>&#125;</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>linux install docker</title>
    <url>/2023/05/08/linux-install-docker/</url>
    <content><![CDATA[<p>centos and ubuntu</p>
<span id="more"></span>
<h2 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h2><ol>
<li>更新系统</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum update</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>卸载旧版本的Docker（如果已经安装过）</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装Docker依赖</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>添加Docker源</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>安装Docker</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>启动Docker并设置开机自启</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl start docker</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>

<p>可以通过运行以下命令来验证Docker是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker version</span><br></pre></td></tr></table></figure>

<p>如果正确安装，显示Docker的版本信息。</p>
<h2 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h2><ol>
<li>更新系统</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>安装Docker依赖</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>添加Docker官方GPG密钥</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>添加Docker源</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>更新源并安装Docker</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>启动Docker并设置开机自启</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl start docker</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure>

<p>可以通过运行以下命令来验证Docker是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker version</span><br></pre></td></tr></table></figure>

<p>如果正确安装，将显示Docker的版本信息。</p>
]]></content>
  </entry>
  <entry>
    <title>记一次consul迁移</title>
    <url>/2023/04/04/consul%E8%BF%81%E7%A7%BB/</url>
    <content><![CDATA[<p>原consul集群迁移，需完整还原历史数据的同时更换ip，并升级consul版本。</p>
<span id="more"></span>
<h2 id="consul架构"><a href="#consul架构" class="headerlink" title="consul架构"></a>consul架构</h2><p><img src="/2023/04/04/consul%E8%BF%81%E7%A7%BB/assets.jpg"></p>
<h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><ul>
<li>原机房弃用</li>
<li>原consul使用单一dc，三节点集群</li>
<li>三节点分别提供注册svc服务</li>
<li>原consul版本过低，0.7</li>
<li>使用最新版consul重新部署</li>
<li>此集群使用过久，其中服务注册和kv存储都不能丢弃。</li>
<li>prometheus、k8s集群及某些后端服务依赖于此consul集群</li>
<li>consul-template依赖，同步部分配置config</li>
<li>完整迁移历史数据</li>
</ul>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ol>
<li>保留所有kv及各自节点的service注册信息</li>
<li>升级版本至1.11.1,防止误触删除kv信息等</li>
<li>集群化建设，提供相对稳定服务</li>
</ol>
<h2 id="方案分析"><a href="#方案分析" class="headerlink" title="方案分析"></a>方案分析</h2><ol>
<li>使用snapshot方式可以快照复制完整信息，但遗憾的是host_id与raft信息同样会保留。由于原集群全部节点均下线，所以无法使用此方式。</li>
<li>升级consul版本，新旧版本存在数据压缩及存储方式的不同，因此无法在一个集群内使用版本跨度过大的两个实例。</li>
<li>查阅官网及官方git了解到，1.11.1版本在启动时会重新处理旧数据，使其成为新版本可使用的文件规则。</li>
<li>综上所述，最终考虑使用手动复制迁移service与kv（同集群仅有kv存在数据一致性）</li>
</ol>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li>scp原节点service到新服务器文件路径内，service路径位于 &#x2F;data&#x2F;services</li>
<li>于新服务器内安装docker（restart always），使用consul镜像，mount本地路径（数据持久化）</li>
<li>将原&#x2F;service数据导入挂载的&#x2F;data目录下</li>
<li>docker 启动新节点（此时会发现service内数据已更新为新规则文件）<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --net host --name consul -v /data/consul/data:/consul/data 76802375bc5c agent -server=<span class="literal">true</span> -client=0.0.0.0 -ui --bootstrap-expect=1 -datacenter=srv -data-dir=/consul/data  -node xx.xxx.xx.xxx -<span class="built_in">bind</span> xx.xxx.xx.xxx </span><br></pre></td></tr></table></figure></li>
<li>使用consul operator api 同步kv （无token则省略token）<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"> <span class="comment"># 导出所有kv键值对，注意最后参数&#x27;&#x27;是导出键值对的前缀，为空字符串导出所有</span></span><br><span class="line">consul kv <span class="built_in">export</span> --http-addr=http://xxx.xxx.xxx.xxx:8500  <span class="string">&#x27;&#x27;</span> &gt; /consul/backup/consul_kv.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导入</span></span><br><span class="line">consul kv import --http-addr=http://xxx.xxx.xxx.xxx:8500 -token=b3a9bca3-6e8e-9678-ea35-ccb8fb272d42 @consul_kv.json</span><br></pre></td></tr></table></figure></li>
<li>同方案启动另外两个节点，启动参数中使用join 加入最新master节点,–bootstrap-expect参数需要特别注意，此参数为预期节点数量，只有实际节点数与预期节点数相同时，该节点才会正常启用leader选举，否则会no leader</li>
</ol>
<h2 id="Required-Ports-v1-15-x-latest"><a href="#Required-Ports-v1-15-x-latest" class="headerlink" title="Required Ports v1.15.x (latest)"></a>Required Ports v1.15.x (latest)</h2><ul>
<li>DNS: The DNS server (TCP and UDP)                         8600</li>
<li>HTTP: The HTTP API (TCP Only)                             8500</li>
<li>LAN Serf: The Serf LAN port (TCP and UDP)                 8301</li>
<li>Wan Serf: The Serf WAN port (TCP and UDP)                 8302</li>
<li>server: Server RPC address (TCP Only)                     8300</li>
<li>Sidecar Proxy Min: Inclusive min port number to use for automatically assigned sidecar service registrations. 21000</li>
<li>Sidecar Proxy Max: Inclusive max port number to use for automatically assigned sidecar service registrations. 21255</li>
</ul>
<h2 id="scp命令"><a href="#scp命令" class="headerlink" title="scp命令"></a>scp命令</h2><h3 id="本地-发送至-远程"><a href="#本地-发送至-远程" class="headerlink" title="本地 发送至 远程"></a>本地 发送至 远程</h3><ol>
<li>复制单个文件<br>scp 本地文件路径 远程用户名@ip地址:远程路径<br>scp .&#x2F;test.txt <a href="mailto:&#x72;&#x6f;&#111;&#116;&#64;&#x30;&#46;&#x30;&#x2e;&#48;&#46;&#48;">&#x72;&#x6f;&#111;&#116;&#64;&#x30;&#46;&#x30;&#x2e;&#48;&#46;&#48;</a>:&#x2F;home&#x2F;me</li>
<li>复制文件夹<br>scp -r 本地文件夹路径 远程用户名@ip地址:远程路径</li>
</ol>
<h3 id="远程-拷贝至-本地"><a href="#远程-拷贝至-本地" class="headerlink" title="远程 拷贝至 本地"></a>远程 拷贝至 本地</h3><ol>
<li>复制单个文件<br>scp 远程用户名@ip地址:远程路径 本地文件路径</li>
<li>复制文件夹<br>scp -r 远程用户名@ip地址:远程路径 本地文件夹路径</li>
</ol>
<h2 id="consul-启动参数"><a href="#consul-启动参数" class="headerlink" title="consul 启动参数"></a>consul 启动参数</h2><ul>
<li>-server：以 server 模式启动代理</li>
<li>-data-dir： 配置 consul 数据存储路径</li>
</ul>
<p>##bootstrap-expect 未设置的情况会导致consul无法完成选举，各存活节点选举自身。全部节点需设置相同节点数，且实际数量要与期望节点数目一制</p>
<ul>
<li>-bootstrap-expect：期望的 server 节点数目，consul 一直等到指定sever数目的时候才会引导整个集群</li>
<li>-bind：绑定的 IP 地址，默认是 0.0.0.0</li>
<li>-node：节点在集群中的名称，在一个集群中必须是唯一的，默认是该节点的主机名</li>
<li>-ui： 开启 web 管理界面</li>
<li>-config-dir：配置文件目录，所有以 .json 结尾的文件都会被加载，可以是服务或 Consul 自身的配置</li>
<li>-client：提供 HTTP、DNS、RPC 等服务，默认是127.0.0.1,不对外提供服务，如果需要则改成 0.0.0.0</li>
<li>-join：加入一个已经启动的 agent 的 ip 地址，可以指定多个</li>
<li>-retry-join：允许你在第一次失败后进行尝试</li>
<li>-retry-interval：两次 join 之间的时间间隔，默认是30s</li>
<li>-retry-max：尝试重复 join 的次数，默认是0，即无限次尝试</li>
<li>-log-level：日志信息级别，默认是info，还可以选择：trace、debug、info、warn、err</li>
</ul>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><ol>
<li>no leader error<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">原因：</span><br><span class="line">    出现此问题是由于consul leader选举失效产生的。</span><br><span class="line">    consul采用raft选举协议，由于consul并没有很好的自适应策略，导致其严格按照启动参数中的配置来进行预期选举。若期望节点数与集群实际节点数不符，节点将持续选择自身作为集群leader，而不是采用随机算发中的比值选举。</span><br><span class="line">解决方法：</span><br><span class="line">    1.重启consul，修改启动参数中bootstrap-expect的数值。</span><br><span class="line">    2.强制使用raft peers.json指定leader，不同版本json格式不同，node_id文件若丢失则重启重新生成。后续维护不便。</span><br><span class="line">    3.使用operator命令强制处理节点</span><br></pre></td></tr></table></figure></li>
<li>集群方案kv获取稳定性保障<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">由于consul提供的调用包/api实现的是单节点信息获取。因此当使用的节点down时，将不能稳定发挥集群效用。</span><br><span class="line">对于仅使用kv的调用来说，可以考虑在上层增加load balance，同时集群内至少保证有两个及以上service节点。分别为不同节点设置不同的预期节点数。在某一client端down后仍旧可以短期内提供服务，等待restart。</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>四小时睡眠后的一天</title>
    <url>/2023/03/29/%E5%9B%9B%E5%B0%8F%E6%97%B6%E7%9D%A1%E7%9C%A0%E5%90%8E%E7%9A%84%E4%B8%80%E5%A4%A9/</url>
    <content><![CDATA[<h2 id="除了困还是困"><a href="#除了困还是困" class="headerlink" title="除了困还是困"></a>除了困还是困</h2>]]></content>
  </entry>
  <entry>
    <title>某500公司golang面试题</title>
    <url>/2022/04/13/%E6%9F%90500%E5%85%AC%E5%8F%B8golang%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    <content><![CDATA[<p>面试内容由浅入深，值得参考</p>
<span id="more"></span>
<h2 id="语言基础"><a href="#语言基础" class="headerlink" title="语言基础"></a>语言基础</h2><ul>
<li>语言分类(编译与解释)</li>
<li>Go,C&#x2F;C++</li>
<li>切片内存结构</li>
<li>Map内存结构</li>
<li>函数参数传递(值,指针)</li>
<li>defer调用时机(调用顺序,return先后顺序,代码块等)</li>
<li>函数绑定方式(区别)</li>
<li>Go如何实现继承(多接口继承等)</li>
<li>chan有缓冲,无缓冲</li>
<li>select中default作用(读chan,写chan)</li>
<li>Go中的闭包(需要注意什么)</li>
</ul>
<h3 id="高阶"><a href="#高阶" class="headerlink" title="高阶"></a>高阶</h3><ul>
<li>go协程为什么性能高(真的高吗?相比Java高在什么地方)</li>
<li>协程与线程的区别关系(真的比线程性能高吗?什么情况有优势,什么情况无优势)</li>
<li>GC触发机制是什么</li>
<li>协程调试机制是什么</li>
<li>如何分析内存使用情况(定位内存泄露,死锁)</li>
</ul>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><ul>
<li>restful,rpc区别</li>
<li>用过哪些go的网络框架</li>
<li>restful常用的动作有哪些</li>
<li>一个url绑定多个动作</li>
<li>一个网络请求阻塞会影响其它的吗?</li>
</ul>
<h3 id="高阶-1"><a href="#高阶-1" class="headerlink" title="高阶"></a>高阶</h3><ul>
<li>ip,tcp,http层级与关系</li>
<li>tcp握手与断开大致流程</li>
<li>什么是tcp粘包(工作中是否遇到过,如何解决)</li>
<li>工作中是否做过跨公网通信的项目(如何提高网络吞吐量)</li>
</ul>
<h2 id="数据库-Sql-NoSql"><a href="#数据库-Sql-NoSql" class="headerlink" title="数据库(Sql,NoSql)"></a>数据库(Sql,NoSql)</h2><ul>
<li>mysql存储引擎有哪几种,各自的特点是什么?</li>
<li>视图与表的关系(区别)</li>
<li>关联查询有哪几种(区别)</li>
<li>索引的分类(区别)</li>
<li>索引的匹配规则</li>
<li>索引是否越多越好,为什么?</li>
<li>是否使用过es或是某种no-sql存储系统?</li>
<li>es的分片机制是什么(如果用过es)</li>
<li>es查询分类?(如果用过es)</li>
<li>es分词与全文检索区别(如果用过es)</li>
<li>redis为什么快?</li>
<li>工作中什么场景中用到过redis,怎么用的?</li>
</ul>
<h3 id="高阶-2"><a href="#高阶-2" class="headerlink" title="高阶"></a>高阶</h3><ul>
<li>什么是二级索引(与一级索引的区别)</li>
<li>什么是回表如何避免回表</li>
<li>mysql中innodb索引的存储结构(为什么切换B-到B+)</li>
<li>redis的key驱逐策略有哪几种</li>
<li>redis的key驱逐时机</li>
<li>redis是否具体的持久化的能力(分哪向种,区别)</li>
</ul>
<h2 id="消息中间件-Kafka"><a href="#消息中间件-Kafka" class="headerlink" title="消息中间件(Kafka)"></a>消息中间件(Kafka)</h2><ul>
<li>是否使用过kafka</li>
<li>kafka中consumer与group的关系</li>
<li>服务如何保证不会重复消费消息</li>
<li>生产者如何保证消息的一致性</li>
</ul>
<h3 id="高阶-3"><a href="#高阶-3" class="headerlink" title="高阶"></a>高阶</h3><ul>
<li>什么是kafka扩(缩)容</li>
<li>扩(缩)容时服务应该(可能)需要做什么工作</li>
</ul>
<h2 id="云原生"><a href="#云原生" class="headerlink" title="云原生"></a>云原生</h2><ul>
<li><ul>
<li>工作中是否使用docker</li>
</ul>
</li>
<li><ul>
<li>工作路是否使用某种k8s平台</li>
</ul>
</li>
<li><ul>
<li>IaaS,PaaS,SaaS是指什么,k8s属于哪一种</li>
</ul>
</li>
</ul>
<h3 id="高阶-4"><a href="#高阶-4" class="headerlink" title="高阶"></a>高阶</h3><ul>
<li>是否了解k8s平台的关键组件及其主要功能</li>
<li>什么是k8s的CRD,Operators(关系,区别)</li>
<li>是否做过k8s的二次开发</li>
<li>在k8s平台运行的服务出错(崩溃,死锁,内存泄露)如何解决</li>
<li>是否了解或是使用过serverless平台</li>
</ul>
<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><ul>
<li>随机选择一些简单的算法</li>
</ul>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul>
<li>是否了解或是使用过大数据平台</li>
<li>hadoop与spark关系(区别)</li>
<li>是否了解或是使用过flink</li>
<li>是否使用过或了解prometheus监控系统</li>
<li>是否分析过工作工作中使用过开源系统的源码?</li>
<li>是否参与过某个开源项目(github地址)</li>
</ul>
]]></content>
  </entry>
</search>
